name: Build Image buildah
on: [push]

env:
  REGISTRY: quay.io
  # github.repository as <account>/<repo>
  IMAGE_NAME: quay.io/andrii_soldatenko/debug
  IMAGE_TAG: latest

jobs:
  build-image:
    name: Build image buildah
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # TODO: replace with docker-qemu to speedup
      # - name: Install qemu dependency
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y qemu-user-static
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build Image
        id: build_image_multiplatform
        uses: redhat-actions/buildah-build@v2.13
        with:
          image: ${{ env.IMAGE_NAME }}
          tags: ${{ env.IMAGE_TAG }} ${{ github.sha }}
          platforms: linux/amd64, linux/arm64
          containerfiles: |
            ./Dockerfile

      - name: Echo Outputs
        run: |
          echo "Image: ${{ steps.build_image_multiplatform.outputs.image }}"
          echo "Tags: ${{ steps.build_image_multiplatform.outputs.tags }}"
          echo "Tagged Image: ${{ steps.build_image_multiplatform.outputs.image-with-tag }}"

      - name: Check images created
        run: buildah images | grep '${{ env.IMAGE_NAME }}'

      - name: Check manifest
        run: |
          set -x
          buildah manifest inspect ${{ steps.build_image_multiplatform.outputs.image }}:${{ env.IMAGE_TAG }}

      # Podman Login action (https://github.com/redhat-actions/podman-login) also be used to log in,
      # in which case 'username' and 'password' can be omitted.
      - name: Push To quay.io
        id: push-to-quay
        uses: redhat-actions/push-to-registry@v2
        with:
          image: ${{ steps.build_image_multiplatform.outputs.image }}
          tags: ${{ steps.build_image_multiplatform.outputs.tags }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Print image url
        run: echo "Image pushed to ${{ steps.push-to-quay.outputs.registry-paths }}"
